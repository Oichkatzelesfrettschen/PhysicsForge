name: Build All Papers

on:
  push:
    branches: [ main ]
    paths:
      - 'synthesis/papers/**'
      - 'synthesis/shared/**'
      - '.github/workflows/papers_build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'synthesis/papers/**'
      - 'synthesis/shared/**'
      - '.github/workflows/papers_build.yml'
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  build-papers:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        paper:
          - number: 1
            name: paper1_scalar_field_zpe
            title: "Scalar Field Theory and Zero-Point Energy"
          - number: 2
            name: paper2_exceptional_algebras
            title: "Exceptional Algebras and Crystalline Lattices"
          - number: 3
            name: paper3_fractal_geometry
            title: "Fractal Geometry and Hyperdimensional Fields"
          - number: 4
            name: paper4_em_gravity_unification
            title: "Gravitational-EM Unification"
          - number: 5
            name: paper5_experimental_protocols
            title: "Experimental Protocols for Exotic Quantum States"
          - number: 6
            name: paper6_applications
            title: "Applications to Quantum Computing and Energy Technologies"
    
    name: Build Paper ${{ matrix.paper.number }} - ${{ matrix.paper.title }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache TeX Live packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.texlive
            ~/.texmf-var
            ~/.cache/texmf
          key: ${{ runner.os }}-texlive-papers-${{ hashFiles('synthesis/shared/**') }}
          restore-keys: |
            ${{ runner.os }}-texlive-papers-
            ${{ runner.os }}-texlive-

      - name: Build Paper ${{ matrix.paper.number }} with LaTeX
        id: latex_build
        continue-on-error: true
        uses: xu-cheng/latex-action@v3
        with:
          root_file: paper${{ matrix.paper.number }}_main.tex
          working_directory: synthesis/papers/${{ matrix.paper.name }}
          latexmk_shell_escape: true
          args: -pdf -file-line-error -interaction=nonstopmode -halt-on-error

      - name: Check build status and upload logs
        if: always()
        run: |
          cd synthesis/papers/${{ matrix.paper.name }}
          echo "=== Build Status for Paper ${{ matrix.paper.number }} ==="
          
          # Check if PDF was generated
          if [ -f paper${{ matrix.paper.number }}_main.pdf ]; then
            PDF_SIZE=$(stat -f%z paper${{ matrix.paper.number }}_main.pdf 2>/dev/null || stat -c%s paper${{ matrix.paper.number }}_main.pdf)
            echo "✓ PDF generated: paper${{ matrix.paper.number }}_main.pdf (${PDF_SIZE} bytes)"
            mv paper${{ matrix.paper.number }}_main.pdf ${{ matrix.paper.name }}.pdf
            ls -lh ${{ matrix.paper.name }}.pdf
            echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "✗ PDF generation failed - no output file"
            echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
          fi
          
          # Check for log file and extract errors
          if [ -f paper${{ matrix.paper.number }}_main.log ]; then
            echo ""
            echo "=== LaTeX Error Summary ==="
            grep -i "^!" paper${{ matrix.paper.number }}_main.log | head -20 || echo "No LaTeX errors found (! prefix)"
            echo ""
            echo "=== Undefined Control Sequences ==="
            grep -i "Undefined control sequence" paper${{ matrix.paper.number }}_main.log | head -10 || echo "No undefined control sequences"
            echo ""
            echo "=== Missing References ==="
            grep -i "Reference.*undefined" paper${{ matrix.paper.number }}_main.log | head -10 || echo "No missing references"
            echo ""
            
            # Save log for artifact
            cp paper${{ matrix.paper.number }}_main.log ${{ matrix.paper.name }}.log
          else
            echo "✗ No log file found"
          fi

      - name: Upload Paper ${{ matrix.paper.number }} PDF as artifact
        if: env.BUILD_SUCCESS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.paper.name }}
          path: synthesis/papers/${{ matrix.paper.name }}/${{ matrix.paper.name }}.pdf
          retention-days: 30

      - name: Upload Paper ${{ matrix.paper.number }} build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.paper.name }}-logs
          path: synthesis/papers/${{ matrix.paper.name }}/${{ matrix.paper.name }}.log
          retention-days: 7
          if-no-files-found: ignore

  build-all-papers-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: build-papers
    if: always()
    
    steps:
      - name: Download all paper artifacts
        uses: actions/download-artifact@v4
        with:
          path: papers

      - name: Generate build summary
        run: |
          echo "## Papers Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Paper | Status | Size | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|------|-------|" >> $GITHUB_STEP_SUMMARY
          
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          
          for paper in papers/paper*; do
            if [ -d "$paper" ] && [[ ! "$paper" =~ -logs$ ]]; then
              paper_name=$(basename "$paper")
              pdf_file=$(find "$paper" -name "*.pdf" | head -1)
              log_artifact="papers/${paper_name}-logs"
              
              if [ -f "$pdf_file" ]; then
                size=$(du -h "$pdf_file" | cut -f1)
                echo "| $paper_name | ✓ Built | $size | - |" >> $GITHUB_STEP_SUMMARY
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                if [ -d "$log_artifact" ]; then
                  echo "| $paper_name | ✗ Failed | - | See logs artifact |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| $paper_name | ✗ Failed | - | No logs |" >> $GITHUB_STEP_SUMMARY
                fi
                FAIL_COUNT=$((FAIL_COUNT + 1))
              fi
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Successfully built: $SUCCESS_COUNT papers" >> $GITHUB_STEP_SUMMARY
          echo "- ✗ Failed to build: $FAIL_COUNT papers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Successfully built papers are available as PDF artifacts (30-day retention)" >> $GITHUB_STEP_SUMMARY
          echo "- Build logs for all papers are available as log artifacts (7-day retention)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Note" >> $GITHUB_STEP_SUMMARY
          echo "Papers with incomplete chapters or undefined LaTeX macros may fail to build." >> $GITHUB_STEP_SUMMARY
          echo "This is expected during development. Check log artifacts for specific errors." >> $GITHUB_STEP_SUMMARY
